<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MegaCable API - Cliente de Prueba</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, #007cba, #005a87);
      color: white;
      border-radius: 8px;
    }

    .section {
      background: #f9f9f9;
      padding: 20px;
      margin: 15px 0;
      border-radius: 8px;
      border-left: 4px solid #007cba;
    }

    .result {
      background: #e8f5e8;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      border: 1px solid #4caf50;
    }

    .error {
      background: #ffe8e8;
      border: 1px solid #f44336;
    }

    button {
      background: #007cba;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
      transition: background 0.3s;
    }

    button:hover {
      background: #005a87;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    input {
      padding: 10px;
      margin: 5px;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    input:focus {
      border-color: #007cba;
      outline: none;
    }

    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-weight: bold;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      border: 1px solid #e9ecef;
      overflow-x: auto;
      font-size: 12px;
    }

    /* Estilos para tablas de resultados */
    .result-table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
      background: white;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .result-table th {
      background: #007cba;
      color: white;
      padding: 12px;
      text-align: left;
      font-weight: 600;
    }

    .result-table td {
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
    }

    .result-table tr:hover {
      background: #f5f5f5;
    }

    .result-table tr:last-child td {
      border-bottom: none;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
    }

    .badge.success {
      background: #d4edda;
      color: #155724;
    }

    .badge.error {
      background: #f8d7da;
      color: #721c24;
    }

    .badge.info {
      background: #d1ecf1;
      color: #0c5460;
    }

    .proyeccion-summary {
      background: #e8f4fd;
      padding: 15px;
      border-radius: 6px;
      margin: 10px 0;
      border-left: 4px solid #007cba;
    }

    .proyeccion-mensual {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin: 15px 0;
    }

    .mes-card {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 10px;
      text-align: center;
    }

    .mes-card h4 {
      margin: 0 0 8px 0;
      color: #007cba;
    }

    .mes-card .amount {
      font-size: 18px;
      font-weight: bold;
      color: #28a745;
    }

    .table-container {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin: 15px 0;
    }

    .result-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .result-table th {
      background: #007cba;
      color: white;
      padding: 12px 15px;
      text-align: left;
      font-weight: 600;
    }

    .result-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #e9ecef;
      vertical-align: top;
    }

    .result-table tr:last-child td {
      border-bottom: none;
    }

    .result-table tr:nth-child(even) {
      background: #f8f9fa;
    }

    .result-table tr:hover {
      background: #e3f2fd;
    }

    .badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
    }

    .badge.success {
      background: #d4edda;
      color: #155724;
    }

    .badge.error {
      background: #f8d7da;
      color: #721c24;
    }

    .badge.warning {
      background: #fff3cd;
      color: #856404;
    }

    .proyeccion-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .proyeccion-card {
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .proyeccion-card h4 {
      margin: 0 0 10px 0;
      color: #007cba;
      border-bottom: 2px solid #007cba;
      padding-bottom: 5px;
    }

    .proyeccion-mes {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
      padding: 5px;
      background: #f8f9fa;
      border-radius: 4px;
    }

    .json-toggle {
      background: #6c757d;
      font-size: 12px;
      padding: 8px 12px;
      margin-top: 10px;
    }

    .json-toggle:hover {
      background: #545b62;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üöÄ MegaCable API</h1>
      <p>Cliente de Prueba para Proyecciones de Contratos</p>
    </div>

    <div id="status" class="status info">
      üîÑ Verificando conexi√≥n con la API...
    </div>

    <div class="section">
      <h2>üîç Validar Contrato</h2>
      <input type="text" id="contratoValidar" placeholder="Ej: CTR-2025-001" value="CTR-2025-001">
      <button onclick="validarContrato()" id="btnValidar">Validar Contrato</button>
    </div>

    <div class="section">
      <h2>üìä Generar Proyecci√≥n de Contrato</h2>
      <input type="text" id="contratoProyeccion" placeholder="Ej: CTR-2025-001" value="CTR-2025-001">
      <input type="number" id="mesesFuturos" placeholder="Meses" value="6" min="1" max="24">
      <button onclick="generarProyeccion()" id="btnProyeccion">Generar Proyecci√≥n</button>
    </div>

    <div class="section">
      <h2>üìà Proyecciones M√∫ltiples</h2>
      <p>Procesar m√∫ltiples contratos de una vez:</p>
      <button onclick="proyeccionesMultiples()" id="btnMultiple">Procesar M√∫ltiples Contratos</button>
    </div>

    <div class="section">
      <h2>üß™ Contratos de Prueba Disponibles</h2>
      <div style="display: flex; flex-wrap: wrap; gap: 10px;">
        <button onclick="probarContrato('CTR-2025-001')">CTR-2025-001</button>
        <button onclick="probarContrato('CTR-2025-002')">CTR-2025-002</button>
        <button onclick="probarContrato('CTR-2025-003')">CTR-2025-003</button>
        <button onclick="probarContrato('CTR-2025-004')">CTR-2025-004</button>
      </div>
      <div style="margin-top: 10px;">
        <button onclick="probarContrato('INVALIDO-123')" style="background: #f44336;">Probar Contrato Inv√°lido</button>
        <button onclick="probarContrato('CTR-2025-999')" style="background: #f44336;">CTR-2025-999 (No existe)</button>
      </div>
    </div>

    <div id="resultado" class="result" style="display:none;">
      <h3>üìã Resultado:</h3>
      <pre id="resultadoTexto"></pre>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:5011/api/Proyeccion';

    // Verificar conexi√≥n con la API al cargar la p√°gina
    window.onload = async function () {
      await verificarConexion();
    };

    // Funci√≥n para formatear moneda
    function formatCurrency(amount) {
      return new Intl.NumberFormat('es-MX', {
        style: 'currency',
        currency: 'MXN'
      }).format(amount);
    }

    // Funci√≥n para formatear fecha
    function formatDate(dateString) {
      return new Date(dateString).toLocaleDateString('es-MX');
    }

    // Verificar que la API est√© ejecut√°ndose
    async function verificarConexion() {
      const statusDiv = document.getElementById('status');
      try {
        const response = await fetch(API_BASE + '/contrato/CTR-2025-001/validar');
        if (response.ok) {
          statusDiv.className = 'status success';
          statusDiv.innerHTML = '‚úÖ Conexi√≥n exitosa con MegaCable API';
        } else {
          throw new Error('API respondi√≥ con error');
        }
      } catch (error) {
        statusDiv.className = 'status error';
        statusDiv.innerHTML = '‚ùå No se puede conectar con la API. Aseg√∫rate de que est√© ejecut√°ndose en http://localhost:5011';
      }
    }

    // Funci√≥n para renderizar respuestas de forma visual
    function renderResponse(data, endpoint) {
      const resultDiv = document.getElementById('resultado');
      const resultText = document.getElementById('resultadoTexto');

      resultDiv.style.display = 'block';
      resultDiv.className = 'result';

      let html = `<h3>üìã Resultado: ${endpoint}</h3>`;

      // Validaci√≥n de contrato
      if (endpoint === 'Validar Contrato' && (data.hasOwnProperty('valido') || data.hasOwnProperty('esValido'))) {
        const esValido = data.valido || data.esValido;
        const badgeClass = esValido ? 'success' : 'error';
        const message = esValido ? '‚úì Contrato V√°lido' : '‚úó Contrato No V√°lido';

        html += `
          <div class="badge ${badgeClass}" style="font-size: 16px; padding: 8px 16px; margin: 10px 0;">${message}</div>
          ${data.mensaje ? `<p style="margin-top: 10px;"><strong>Mensaje:</strong> ${data.mensaje}</p>` : ''}
          <div class="table-container" style="margin-top: 15px;">
            <table class="result-table">
              <tr><td><strong>N√∫mero de Contrato:</strong></td><td>${data.numeroContrato}</td></tr>
              <tr><td><strong>Estado:</strong></td><td><span class="badge ${badgeClass}">${esValido ? 'V√°lido' : 'Inv√°lido'}</span></td></tr>
              <tr><td><strong>Fecha de Validaci√≥n:</strong></td><td>${formatDate(data.fechaValidacion)}</td></tr>
            </table>
          </div>
        `;
      }
      // Proyecci√≥n individual (formato nuevo)
      else if (data.hasOwnProperty('proyeccionesMensuales') && data.hasOwnProperty('resumenEjecutivo')) {
        const proyecciones = data.proyeccionesMensuales;
        const resumen = data.resumenEjecutivo;

        html += `
          <div class="proyeccion-summary">
            <h4>üìä Informaci√≥n del Contrato</h4>
            <div class="table-container">
              <table class="result-table">
                <tr><td><strong>N√∫mero de Contrato:</strong></td><td>${data.numeroContrato}</td></tr>
                <tr><td><strong>Meses Proyectados:</strong></td><td>${data.mesesFuturos} meses</td></tr>
                <tr><td><strong>Estado:</strong></td><td><span class="badge ${data.exitoso ? 'success' : 'error'}">${data.exitoso ? 'Exitoso' : 'Error'}</span></td></tr>
                <tr><td><strong>Fecha de Generaci√≥n:</strong></td><td>${formatDate(data.fechaGeneracion)}</td></tr>
              </table>
            </div>
          </div>

          <div class="proyeccion-summary">
            <h4>üí∞ Resumen Ejecutivo</h4>
            <div class="table-container">
              <table class="result-table">
                <tr><td><strong>Pago M√≠nimo:</strong></td><td>${formatCurrency(resumen.pagoMinimo)}</td></tr>
                <tr><td><strong>Pago M√°ximo:</strong></td><td>${formatCurrency(resumen.pagoMaximo)}</td></tr>
                <tr><td><strong>Pago Promedio:</strong></td><td>${formatCurrency(resumen.pagoPromedio)}</td></tr>
                <tr><td><strong>Total del Per√≠odo:</strong></td><td><strong style="color: #007cba;">${formatCurrency(resumen.totalPeriodo)}</strong></td></tr>
                <tr><td><strong>Ahorros Totales:</strong></td><td><strong style="color: #28a745;">${formatCurrency(resumen.ahorrosTotales)}</strong></td></tr>
                <tr><td><strong>% de Ahorro:</strong></td><td><span class="badge success">${resumen.porcentajeAhorroTotal.toFixed(2)}%</span></td></tr>
              </table>
            </div>
          </div>

          <h4>üìÖ Proyecciones Mensuales Detalladas</h4>
          <div class="proyeccion-grid">
        `;

        proyecciones.forEach(mes => {
          const tieneAlertas = mes.tieneAlertas ? '‚ö†Ô∏è' : '';
          const iconoPromo = mes.promocionesActivas !== 'Sin promociones' ? 'üéâ' : 'üìã';

          html += `
            <div class="proyeccion-card" style="${mes.tieneAlertas ? 'border-left: 4px solid #ff9800;' : ''}">
              <h4>${iconoPromo} ${mes.mesNombre} ${tieneAlertas}</h4>
              <div class="table-container" style="margin: 0;">
                <table class="result-table" style="font-size: 12px;">
                  <tr><td><strong>Subtotal Servicios:</strong></td><td>${formatCurrency(mes.subtotalServicios)}</td></tr>
                  <tr><td><strong>Descuentos:</strong></td><td style="color: #28a745;">-${formatCurrency(mes.descuentosPromociones)}</td></tr>
                  <tr><td><strong>Impuestos:</strong></td><td>${formatCurrency(mes.impuestos)}</td></tr>
                  <tr style="background: #e8f4fd;"><td><strong>Total:</strong></td><td><strong>${formatCurrency(mes.totalProyectado)}</strong></td></tr>
                </table>
              </div>
              <div style="margin-top: 10px; font-size: 11px;">
                <div><strong>Promociones:</strong> ${mes.promocionesActivas}</div>
                ${mes.promocionesVencen ? `<div style="color: #ff9800;"><strong>Vencen:</strong> ${mes.promocionesVencen}</div>` : ''}
                <div style="margin-top: 5px; font-style: italic;">${mes.notas}</div>
              </div>
            </div>
          `;
        });

        html += `</div>`;

        html += `
          <div class="proyeccion-summary">
            <h4>üí° ${data.mensaje}</h4>
          </div>
        `;
      }
      // Proyecci√≥n individual (formato anterior)
      else if (data.hasOwnProperty('contratoInfo') && data.hasOwnProperty('proyeccionMensual')) {
        const contratoInfo = data.contratoInfo;
        const proyecciones = data.proyeccionMensual;

        html += `
          <div class="proyeccion-summary">
            <h4>Informaci√≥n del Contrato</h4>
            <div class="table-container">
              <table class="result-table">
                <tr><td><strong>N√∫mero de Contrato:</strong></td><td>${contratoInfo.numeroContrato}</td></tr>
                <tr><td><strong>Cliente:</strong></td><td>${contratoInfo.nombreCliente}</td></tr>
                <tr><td><strong>Plan:</strong></td><td>${contratoInfo.planServicio}</td></tr>
                <tr><td><strong>Pago Mensual:</strong></td><td>${formatCurrency(contratoInfo.pagoMensual)}</td></tr>
                <tr><td><strong>Estado:</strong></td><td><span class="badge ${contratoInfo.estado === 'Activo' ? 'success' : 'warning'}">${contratoInfo.estado}</span></td></tr>
                <tr><td><strong>Fecha de Inicio:</strong></td><td>${formatDate(contratoInfo.fechaInicio)}</td></tr>
              </table>
            </div>
          </div>

          <h4>Proyecci√≥n Mensual</h4>
          <div class="proyeccion-grid">
        `;

        proyecciones.forEach(mes => {
          html += `
            <div class="proyeccion-card">
              <h4>${mes.mes} ${mes.a√±o}</h4>
              <div class="proyeccion-mes">
                <span>Proyectado:</span>
                <strong style="color: #28a745;">${formatCurrency(mes.montoProyectado)}</strong>
              </div>
            </div>
          `;
        });

        html += `</div>`;

        // Calcular total proyectado
        const totalProyectado = proyecciones.reduce((sum, mes) => sum + mes.montoProyectado, 0);
        html += `
          <div class="proyeccion-summary">
            <h4>üí∞ Total Proyectado: ${formatCurrency(totalProyectado)}</h4>
          </div>
        `;
      }
      // Proyecciones m√∫ltiples
      else if (Array.isArray(data.proyecciones)) {
        const proyecciones = data.proyecciones;

        html += `
          <h4>Proyecciones M√∫ltiples (${proyecciones.length} contratos procesados)</h4>
          <div class="table-container">
            <table class="result-table">
              <thead>
                <tr>
                  <th>Contrato</th>
                  <th>Cliente</th>
                  <th>Plan</th>
                  <th>Pago Mensual</th>
                  <th>Estado</th>
                  <th>Total Proyectado</th>
                </tr>
              </thead>
              <tbody>
        `;

        let granTotal = 0;
        proyecciones.forEach(proyeccion => {
          const contratoInfo = proyeccion.contratoInfo;
          const totalProyectado = proyeccion.proyeccionMensual.reduce((sum, mes) => sum + mes.montoProyectado, 0);
          granTotal += totalProyectado;

          html += `
            <tr>
              <td>${contratoInfo.numeroContrato}</td>
              <td>${contratoInfo.nombreCliente}</td>
              <td>${contratoInfo.planServicio}</td>
              <td>${formatCurrency(contratoInfo.pagoMensual)}</td>
              <td><span class="badge ${contratoInfo.estado === 'Activo' ? 'success' : 'warning'}">${contratoInfo.estado}</span></td>
              <td><strong>${formatCurrency(totalProyectado)}</strong></td>
            </tr>
          `;
        });

        html += `
              </tbody>
            </table>
          </div>
          <div class="proyeccion-summary">
            <h4>üí∞ Gran Total Proyectado: ${formatCurrency(granTotal)}</h4>
          </div>
        `;
      }
      // Fallback: mostrar JSON con bot√≥n toggle
      else {
        html += `
          <button class="json-toggle" onclick="toggleJson()">Ver JSON Completo</button>
          <div id="jsonContent" style="display: none;">
            <pre>${JSON.stringify(data, null, 2)}</pre>
          </div>
        `;
      }

      html += `<p style="margin-top: 20px; font-size: 12px; color: #666;">
        <strong>Timestamp:</strong> ${new Date().toLocaleString()}
      </p>`;

      resultText.innerHTML = html;

      // Scroll suave hacia el resultado
      resultDiv.scrollIntoView({ behavior: 'smooth' });
    }

    // Funci√≥n para mostrar errores
    function mostrarError(error, endpoint) {
      const resultDiv = document.getElementById('resultado');
      const resultText = document.getElementById('resultadoTexto');

      resultDiv.style.display = 'block';
      resultDiv.className = 'result error';

      resultText.innerHTML = `
        <h3>‚ùå Error en: ${endpoint}</h3>
        <div class="badge error" style="font-size: 16px; padding: 8px 16px;">${error}</div>
        <p style="margin-top: 10px; font-size: 12px; color: #666;">
          <strong>Timestamp:</strong> ${new Date().toLocaleString()}
        </p>
      `;

      resultDiv.scrollIntoView({ behavior: 'smooth' });
    }

    // Toggle para mostrar/ocultar JSON
    function toggleJson() {
      const jsonContent = document.getElementById('jsonContent');
      const button = document.querySelector('.json-toggle');

      if (jsonContent.style.display === 'none') {
        jsonContent.style.display = 'block';
        button.textContent = 'Ocultar JSON';
      } else {
        jsonContent.style.display = 'none';
        button.textContent = 'Ver JSON Completo';
      }
    }

    // Funci√≥n para deshabilitar/habilitar botones
    function setLoading(isLoading) {
      const buttons = document.querySelectorAll('button');
      buttons.forEach(btn => btn.disabled = isLoading);
    }

    // Validar contrato
    async function validarContrato() {
      const contrato = document.getElementById('contratoValidar').value.trim();

      if (!contrato) {
        alert('Por favor ingresa un n√∫mero de contrato');
        return;
      }

      setLoading(true);
      try {
        const response = await fetch(`${API_BASE}/contrato/${contrato}/validar`);
        const data = await response.json();

        if (response.ok) {
          renderResponse(data, 'Validar Contrato');
        } else {
          mostrarError(data.mensaje || 'Error al validar contrato', 'Validar Contrato');
        }
      } catch (error) {
        console.error('Error:', error);
        mostrarError('Error de conexi√≥n al validar contrato', 'Validar Contrato');
      }
      setLoading(false);
    }

    // Generar proyecci√≥n
    async function generarProyeccion() {
      const contrato = document.getElementById('contratoProyeccion').value.trim();
      const meses = document.getElementById('mesesFuturos').value;

      if (!contrato) {
        alert('Por favor ingresa un n√∫mero de contrato');
        return;
      }

      if (meses < 1 || meses > 24) {
        alert('Los meses deben estar entre 1 y 24');
        return;
      }

      setLoading(true);
      try {
        const response = await fetch(`${API_BASE}/contrato/${contrato}?mesesFuturos=${meses}`);
        const data = await response.json();

        if (response.ok) {
          renderResponse(data, 'Generar Proyecci√≥n');
        } else {
          mostrarError(data.mensaje || 'Error al generar proyecci√≥n', 'Generar Proyecci√≥n');
        }
      } catch (error) {
        console.error('Error:', error);
        mostrarError('Error de conexi√≥n al generar proyecci√≥n', 'Generar Proyecci√≥n');
      }
      setLoading(false);
    }

    // Proyecciones m√∫ltiples
    async function proyeccionesMultiples() {
      const solicitudes = [
        { numeroContrato: "CTR-2025-001", mesesFuturos: 3 },
        { numeroContrato: "CTR-2025-002", mesesFuturos: 6 },
        { numeroContrato: "CTR-2025-003", mesesFuturos: 12 }
      ];

      setLoading(true);
      try {
        const response = await fetch(`${API_BASE}/contratos/multiple`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(solicitudes)
        });

        const data = await response.json();

        if (response.ok) {
          renderResponse({
            solicitudes_procesadas: solicitudes.length,
            proyecciones: data,
            timestamp: new Date().toLocaleString()
          }, 'Proyecciones M√∫ltiples');
        } else {
          mostrarError(data.mensaje || 'Error al procesar m√∫ltiples proyecciones', 'Proyecciones M√∫ltiples');
        }
      } catch (error) {
        console.error('Error:', error);
        mostrarError('Error de conexi√≥n al procesar m√∫ltiples proyecciones', 'Proyecciones M√∫ltiples');
      }
      setLoading(false);
    }

    // Probar contrato espec√≠fico
    async function probarContrato(numeroContrato) {
      document.getElementById('contratoValidar').value = numeroContrato;
      document.getElementById('contratoProyeccion').value = numeroContrato;
      await validarContrato();
    }
  </script>
</body>

</html>