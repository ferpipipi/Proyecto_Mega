<div class="proyecciones-container">
  <!-- Header -->
  <div class="header">
    <h1>üöÄ MegaCable API</h1>
    <p>Proyecciones de Contratos</p>
  </div>

  <!-- Estado de conexi√≥n -->
  <div [class]="estadoConexion.clase">
    {{ estadoConexion.mensaje }}
  </div>

  <!-- Validar Contrato -->
  <div class="section">
    <h2>üîç Validar Contrato</h2>
    <form [formGroup]="formValidacion" (ngSubmit)="validarContrato()">
      <div class="form-row">
        <input type="text" formControlName="numeroContrato" placeholder="Ej: CTR-2025-001" class="form-input">
        <button type="submit" [disabled]="cargando || formValidacion.invalid" class="btn btn-primary">
          {{ cargando ? 'Validando...' : 'Validar Contrato' }}
        </button>
      </div>

      <!-- Error de validaci√≥n -->
      <div *ngIf="errorValidacion" class="error-message">
        {{ errorValidacion }}
      </div>

      <!-- Resultado de validaci√≥n -->
      <div *ngIf="resultadoValidacion" class="result-card">
        <h3>üìã Resultado de Validaci√≥n</h3>

        <div class="validation-badge" [class.success]="esContratoValido(resultadoValidacion)"
          [class.error]="!esContratoValido(resultadoValidacion)">
          {{ esContratoValido(resultadoValidacion) ? '‚úì Contrato V√°lido' : '‚úó Contrato No V√°lido' }}
        </div>

        <div class="result-table">
          <div class="table-row">
            <span class="label">N√∫mero de Contrato:</span>
            <span class="value">{{ resultadoValidacion.numeroContrato }}</span>
          </div>
          <div class="table-row">
            <span class="label">Estado:</span>
            <span class="value">
              <span class="badge" [class.success]="esContratoValido(resultadoValidacion)"
                [class.error]="!esContratoValido(resultadoValidacion)">
                {{ esContratoValido(resultadoValidacion) ? 'V√°lido' : 'Inv√°lido' }}
              </span>
            </span>
          </div>
          <div class="table-row">
            <span class="label">Fecha de Validaci√≥n:</span>
            <span class="value">{{ formatDate(resultadoValidacion.fechaValidacion) }}</span>
          </div>
          <div *ngIf="resultadoValidacion.mensaje" class="table-row">
            <span class="label">Mensaje:</span>
            <span class="value">{{ resultadoValidacion.mensaje }}</span>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Generar Proyecci√≥n -->
  <div class="section">
    <h2>üìä Generar Proyecci√≥n de Contrato</h2>
    <form [formGroup]="formProyeccion" (ngSubmit)="generarProyeccion()">
      <div class="form-row">
        <input type="text" formControlName="numeroContrato" placeholder="Ej: CTR-2025-001" class="form-input">
        <input type="number" formControlName="mesesFuturos" placeholder="Meses" min="1" max="24" class="form-input">
        <button type="submit" [disabled]="cargando || formProyeccion.invalid" class="btn btn-primary">
          {{ cargando ? 'Generando...' : 'Generar Proyecci√≥n' }}
        </button>
      </div>

      <!-- Error de proyecci√≥n -->
      <div *ngIf="errorProyeccion" class="error-message">
        {{ errorProyeccion }}
      </div>

      <!-- Resultado de proyecci√≥n -->
      <div *ngIf="resultadoProyeccion" class="result-card">
        <h3>üìä Proyecci√≥n de Contrato</h3>

        <!-- Informaci√≥n del contrato -->
        <div class="proyeccion-summary">
          <h4>üìã Informaci√≥n del Contrato</h4>
          <div class="result-table">
            <div class="table-row">
              <span class="label">N√∫mero de Contrato:</span>
              <span class="value">{{ resultadoProyeccion.numeroContrato }}</span>
            </div>
            <div class="table-row">
              <span class="label">Meses Proyectados:</span>
              <span class="value">{{ resultadoProyeccion.mesesFuturos }} meses</span>
            </div>
            <div class="table-row">
              <span class="label">Estado:</span>
              <span class="value">
                <span class="badge" [class.success]="resultadoProyeccion.exitoso"
                  [class.error]="!resultadoProyeccion.exitoso">
                  {{ resultadoProyeccion.exitoso ? 'Exitoso' : 'Error' }}
                </span>
              </span>
            </div>
            <div class="table-row">
              <span class="label">Fecha de Generaci√≥n:</span>
              <span class="value">{{ formatDate(resultadoProyeccion.fechaGeneracion) }}</span>
            </div>
          </div>
        </div>

        <!-- Resumen ejecutivo -->
        <div *ngIf="resultadoProyeccion.resumenEjecutivo" class="proyeccion-summary">
          <h4>üí∞ Resumen Ejecutivo</h4>
          <div class="result-table">
            <div class="table-row">
              <span class="label">Pago M√≠nimo:</span>
              <span class="value">{{ formatCurrency(resultadoProyeccion.resumenEjecutivo.pagoMinimo) }}</span>
            </div>
            <div class="table-row">
              <span class="label">Pago M√°ximo:</span>
              <span class="value">{{ formatCurrency(resultadoProyeccion.resumenEjecutivo.pagoMaximo) }}</span>
            </div>
            <div class="table-row">
              <span class="label">Pago Promedio:</span>
              <span class="value">{{ formatCurrency(resultadoProyeccion.resumenEjecutivo.pagoPromedio) }}</span>
            </div>
            <div class="table-row">
              <span class="label">Total del Per√≠odo:</span>
              <span class="value total">{{ formatCurrency(resultadoProyeccion.resumenEjecutivo.totalPeriodo) }}</span>
            </div>
            <div class="table-row">
              <span class="label">Ahorros Totales:</span>
              <span class="value savings">{{ formatCurrency(resultadoProyeccion.resumenEjecutivo.ahorrosTotales)
                }}</span>
            </div>
            <div class="table-row">
              <span class="label">% de Ahorro:</span>
              <span class="value">
                <span class="badge success">{{ resultadoProyeccion.resumenEjecutivo.porcentajeAhorroTotal.toFixed(2)
                  }}%</span>
              </span>
            </div>
          </div>
        </div>

        <!-- Proyecciones Mensuales Detalladas -->
        <div *ngIf="resultadoProyeccion.proyeccionesMensuales && resultadoProyeccion.proyeccionesMensuales.length"
          class="proyeccion-summary">
          <h4>üìÖ Proyecciones Mensuales Detalladas</h4>

          <div class="proyeccion-grid">
            <div *ngFor="let mes of resultadoProyeccion.proyeccionesMensuales" class="proyeccion-card"
              [class.alert-card]="mes.tieneAlertas">
              <h4>
                <span>{{ mes.promocionesActivas !== 'Sin promociones' ? 'üéâ' : 'üìã' }}</span>
                {{ mes.mesNombre }}
                <span *ngIf="mes.tieneAlertas">‚ö†Ô∏è</span>
              </h4>

              <div class="mes-table">
                <div class="table-row">
                  <span class="label">Subtotal Servicios:</span>
                  <span class="value">{{ formatCurrency(mes.subtotalServicios) }}</span>
                </div>
                <div class="table-row">
                  <span class="label">Descuentos:</span>
                  <span class="value discount">-{{ formatCurrency(mes.descuentosPromociones) }}</span>
                </div>
                <div class="table-row">
                  <span class="label">Impuestos:</span>
                  <span class="value">{{ formatCurrency(mes.impuestos) }}</span>
                </div>
                <div class="table-row total-row">
                  <span class="label"><strong>Total:</strong></span>
                  <span class="value"><strong>{{ formatCurrency(mes.totalProyectado) }}</strong></span>
                </div>
              </div>

              <div class="mes-details">
                <div class="detail-item">
                  <strong>Promociones:</strong> {{ mes.promocionesActivas }}
                </div>
                <div *ngIf="mes.promocionesVencen" class="detail-item expiring">
                  <strong>Vencen:</strong> {{ mes.promocionesVencen }}
                </div>
                <div *ngIf="mes.notas" class="detail-item notes">
                  {{ mes.notas }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Mensaje -->
        <div *ngIf="resultadoProyeccion.mensaje" class="proyeccion-summary">
          <h4>üí° {{ resultadoProyeccion.mensaje }}</h4>
        </div>
      </div>
    </form>
  </div>

  <!-- Proyecciones M√∫ltiples -->
  <div class="section">
    <h2>üìà Proyecciones M√∫ltiples</h2>
    <p>Procesar m√∫ltiples contratos de una vez:</p>
    <button (click)="generarProyeccionesMultiples()" [disabled]="cargando" class="btn btn-primary">
      {{ cargando ? 'Procesando...' : 'Procesar M√∫ltiples Contratos' }}
    </button>

    <!-- Error m√∫ltiple -->
    <div *ngIf="errorMultiple" class="error-message">
      {{ errorMultiple }}
    </div>

    <!-- Resultados m√∫ltiples -->
    <div *ngIf="resultadosMultiples.length" class="result-card">
      <h3>üìä Proyecciones M√∫ltiples ({{ resultadosMultiples.length }} contratos procesados)</h3>

      <div class="table-container">
        <table class="results-table">
          <thead>
            <tr>
              <th>Contrato</th>
              <th>Meses</th>
              <th>Estado</th>
              <th>Total Proyectado</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let proyeccion of resultadosMultiples">
              <td>{{ proyeccion.numeroContrato }}</td>
              <td>{{ proyeccion.mesesFuturos }} meses</td>
              <td>
                <span class="badge" [class.success]="proyeccion.exitoso" [class.error]="!proyeccion.exitoso">
                  {{ proyeccion.exitoso ? 'Exitoso' : 'Error' }}
                </span>
              </td>
              <td><strong>{{ formatCurrency(calcularTotalProyectado(proyeccion)) }}</strong></td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="proyeccion-summary">
        <h4>üí∞ Gran Total Proyectado: {{ formatCurrency(calcularGranTotal()) }}</h4>
      </div>
    </div>
  </div>

  <!-- Contratos de Prueba -->
  <div class="section">
    <h2>üß™ Contratos de Prueba Disponibles</h2>
    <div class="test-buttons">
      <button *ngFor="let contrato of contratosPrueba" (click)="probarContrato(contrato)" [disabled]="cargando"
        class="btn btn-outline">
        {{ contrato }}
      </button>
    </div>
    <div class="test-buttons">
      <button (click)="probarContrato('INVALIDO-123')" [disabled]="cargando" class="btn btn-danger">
        Probar Contrato Inv√°lido
      </button>
      <button (click)="probarContrato('CTR-2025-999')" [disabled]="cargando" class="btn btn-danger">
        CTR-2025-999 (No existe)
      </button>
    </div>
  </div>
</div>